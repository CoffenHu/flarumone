System.register("pusher/main",["flarum/extend","flarum/app","flarum/components/DiscussionList","flarum/components/DiscussionPage","flarum/components/IndexPage","flarum/components/Button"],function(n){"use strict";var t,s,e,i,u,o;return{setters:[function(n){t=n.extend},function(n){s=n["default"]},function(n){e=n["default"]},function(n){i=n["default"]},function(n){u=n["default"]},function(n){o=n["default"]}],execute:function(){s.initializers.add("pusher",function(){var n=m.deferred();$.getScript("//js.pusher.com/3.0/pusher.min.js",function(){var t=new Pusher(s.forum.attribute("pusherKey"),{authEndpoint:s.forum.attribute("apiUrl")+"/pusher/auth",auth:{headers:{Authorization:"Token "+s.session.token}}});n.resolve({main:t.subscribe("public"),user:s.session.user?t.subscribe("private-user"+s.session.user.id()):null})}),s.pusher=n.promise,s.pushedUpdates=[],t(e.prototype,"config",function(n,e,i){var o=this;e||s.pusher.then(function(n){n.main.bind("newPost",function(n){var t=o.props.params;if(!t.q&&!t.sort&&!t.filter){if(t.tags){var e=s.store.getBy("tags","slug",t.tags);if(-1===n.tagIds.indexOf(e.id()))return}var i=String(n.discussionId);s.current.discussion&&i===s.current.discussion.id()||-1!==s.pushedUpdates.indexOf(i)||(s.pushedUpdates.push(i),s.current instanceof u&&s.setTitleCount(s.pushedUpdates.length),m.redraw())}}),t(i,"onunload",function(){return n.main.unbind()})})}),t(e.prototype,"view",function(n){var t=this;if(s.pushedUpdates){var e=s.pushedUpdates.length;e&&n.children.unshift(o.component({className:"Button Button--block DiscussionList-update",onclick:function(){t.refresh(!1).then(function(){t.loadingUpdated=!1,s.pushedUpdates=[],s.setTitleCount(0),m.redraw()}),t.loadingUpdated=!0},loading:this.loadingUpdated,children:s.trans("pusher.show_updated_discussions",{count:e})}))}}),t(e.prototype,"addDiscussion",function(n,t){var e=s.pushedUpdates.indexOf(t.id());-1!==e&&s.pushedUpdates.splice(e,1),s.current instanceof u&&s.setTitleCount(s.pushedUpdates.length),m.redraw()}),t(i.prototype,"config",function(n,e,i){var u=this;e||s.pusher.then(function(n){n.main.bind("newPost",function(n){var t=String(n.discussionId);u.discussion&&u.discussion.id()===t&&u.stream&&!function(){var n=u.discussion.commentsCount();s.store.find("discussions",u.discussion.id()).then(function(){u.stream.update(),document.hasFocus()||(s.setTitleCount(Math.max(0,u.discussion.commentsCount()-n)),$(window).one("focus",function(){return s.setTitleCount(0)}))})}()}),t(i,"onunload",function(){return n.main.unbind()})})}),t(u.prototype,"actionItems",function(n){delete n.refresh}),s.pusher.then(function(n){n.user&&n.user.bind("notification",function(){s.session.user.pushAttributes({unreadNotificationsCount:s.session.user.unreadNotificationsCount()+1,newNotificationsCount:s.session.user.newNotificationsCount()+1}),delete s.cache.notifications,m.redraw()})})})}}});