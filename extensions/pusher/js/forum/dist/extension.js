System.register("pusher/main",["flarum/extend","flarum/app","flarum/components/DiscussionList","flarum/components/DiscussionPage","flarum/components/IndexPage","flarum/components/Button"],function(n){"use strict";var t,e,s,i,u,o;return{setters:[function(n){t=n.extend},function(n){e=n["default"]},function(n){s=n["default"]},function(n){i=n["default"]},function(n){u=n["default"]},function(n){o=n["default"]}],execute:function(){e.initializers.add("pusher",function(){var n=m.deferred();$.getScript("//js.pusher.com/3.0/pusher.min.js",function(){var t=new Pusher(e.forum.attribute("pusherKey"),{authEndpoint:e.forum.attribute("apiUrl")+"/pusher/auth",auth:{headers:{Authorization:"Token "+e.session.token}}});n.resolve({main:t.subscribe("public"),user:e.session.user?t.subscribe("private-user"+e.session.user.id()):null})}),e.pusher=n.promise,e.pushedUpdates=[],t(s.prototype,"config",function(n,s,i){var o=this;s||e.pusher.then(function(n){n.main.bind("newPost",function(n){var t=o.props.params;if(!t.q&&!t.sort&&!t.filter){if(t.tags){var s=e.store.getBy("tags","slug",t.tags);if(-1===n.tagIds.indexOf(s.id()))return}var i=String(n.discussionId);e.current.discussion&&i===e.current.discussion.id()||-1!==e.pushedUpdates.indexOf(i)||(e.pushedUpdates.push(i),e.current instanceof u&&e.setTitleCount(e.pushedUpdates.length),m.redraw())}}),t(i,"onunload",function(){return n.main.unbind()})})}),t(s.prototype,"view",function(n){var t=this;if(e.pushedUpdates){var s=e.pushedUpdates.length;s&&n.children.unshift(o.component({className:"Button Button--block DiscussionList-update",onclick:function(){t.refresh(!1).then(function(){t.loadingUpdated=!1,e.pushedUpdates=[],e.setTitleCount(0),m.redraw()}),t.loadingUpdated=!0},loading:this.loadingUpdated,children:e.trans("pusher.show_updated_discussions",{count:s})}))}}),t(s.prototype,"addDiscussion",function(n,t){var s=e.pushedUpdates.indexOf(t.id());-1!==s&&e.pushedUpdates.splice(s,1),e.current instanceof u&&e.setTitleCount(e.pushedUpdates.length),m.redraw()}),t(i.prototype,"config",function(n,s,i){var u=this;s||e.pusher.then(function(n){n.main.bind("newPost",function(n){var t=String(n.discussionId);u.discussion&&u.discussion.id()===t&&u.stream&&!function(){var n=u.discussion.commentsCount();e.store.find("discussions",u.discussion.id()).then(function(){u.stream.update(),document.hasFocus()||(e.setTitleCount(Math.max(0,u.discussion.commentsCount()-n)),$(window).one("focus",function(){return e.setTitleCount(0)}))})}()}),t(i,"onunload",function(){return n.main.unbind()})})}),t(u.prototype,"actionItems",function(n){delete n.refresh}),e.pusher.then(function(n){n.user&&n.user.bind("notification",function(){e.session.user.pushAttributes({unreadNotificationsCount:e.session.user.unreadNotificationsCount()+1}),delete e.cache.notifications,m.redraw()})})})}}});